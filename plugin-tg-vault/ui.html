<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Telegram Widget — Asset Vault</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 12px; font: 13px/1.35 Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .card { border: 1px solid rgba(0,0,0,.15); border-radius: 10px; padding: 12px; margin: 0 0 12px; background: rgba(127,127,127,.06); }
    .row { display: flex; align-items: center; gap: 8px; }
    .title { font-weight: 600; margin: 0 0 8px; }
    .thumb { width: 40px; height: 40px; border-radius: 8px; background: #fafafa; border: 1px solid rgba(0,0,0,.08); overflow: hidden; display: inline-flex; align-items: center; justify-content: center; }
    .thumb img { max-width: 100%; max-height: 100%; display: block; }
    button { height: 28px; padding: 0 10px; border-radius: 6px; border: 1px solid rgba(0,0,0,.12); background: #0a84ff; color: #fff; cursor: pointer; }
    button.secondary { background: #fff; color: #222; }
    .muted { color: rgba(127,127,127,.9); font-size: 12px; margin-top: 6px; }
    .nowrap { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    input[type=file] { display: none; }
  </style>
</head>
<body>
  <div class="card" id="card-avatar">
    <div class="title">Avatar</div>
    <div class="row">
      <div class="thumb"><img id="avatar-preview" alt=""></div>
      <input id="avatar-file" type="file" accept="image/*">
      <button class="secondary" data-choose="avatar">Choose image</button>
      <button data-upload="avatar">Upload</button>
      <button class="secondary" data-clear="avatar">Clear</button>
    </div>
    <div class="muted nowrap">Saved to Shared Plugin Data: <b>tg_vault</b> / <code>avatarHash</code> · <span id="avatar-hash"></span></div>
  </div>

  <div class="card" id="card-wallpaper">
    <div class="title">Wallpaper</div>
    <div class="row">
      <div class="thumb"><img id="wallpaper-preview" alt=""></div>
      <input id="wallpaper-file" type="file" accept="image/*">
      <button class="secondary" data-choose="wallpaper">Choose image</button>
      <button data-upload="wallpaper">Upload</button>
      <button class="secondary" data-clear="wallpaper">Clear</button>
    </div>
    <div class="muted nowrap">Saved to Shared Plugin Data: <b>tg_vault</b> / <code>wallpaperHash</code> · <span id="wallpaper-hash"></span></div>
  </div>

  <div class="card" id="card-messageImage">
    <div class="title">Message Image</div>
    <div class="row">
      <div class="thumb"><img id="messageImage-preview" alt=""></div>
      <input id="messageImage-file" type="file" accept="image/*">
      <button class="secondary" data-choose="messageImage">Choose image</button>
      <button data-upload="messageImage">Upload</button>
      <button class="secondary" data-clear="messageImage">Clear</button>
    </div>
    <div class="muted nowrap">Saved to Shared Plugin Data: <b>tg_vault</b> / <code>messageImageHash</code> · <span id="messageImage-hash"></span></div>
  </div>

  <script>
    const state = { avatar: '', wallpaper: '', messageImage: '' };

    function setPreview(kind, dataURL) {
      state[kind] = dataURL || '';
      const img = document.getElementById(`${kind}-preview`);
      if (img) img.src = dataURL || '';
    }
    function setHash(kind, hash) {
      const el = document.getElementById(`${kind}-hash`);
      if (el) el.textContent = hash || '';
    }

    for (const kind of ['avatar','wallpaper','messageImage']) {
      const fileInput = document.getElementById(`${kind}-file`);
      const chooseBtn = document.querySelector(`[data-choose="${kind}"]`);
      const uploadBtn = document.querySelector(`[data-upload="${kind}"]`);
      const clearBtn = document.querySelector(`[data-clear="${kind}"]`);

      chooseBtn?.addEventListener('click', () => fileInput?.click());
      fileInput?.addEventListener('change', () => {
        const f = fileInput.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => setPreview(kind, reader.result);
        reader.readAsDataURL(f);
      });

      uploadBtn?.addEventListener('click', () => {
        parent.postMessage({ pluginMessage: { type: 'UPLOAD', target: kind } }, '*');
      });

      clearBtn?.addEventListener('click', () => {
        setPreview(kind, '');
        setHash(kind, '');
        parent.postMessage({ pluginMessage: { type: 'CLEAR', target: kind } }, '*');
      });
    }

    window.onmessage = (event) => {
      const msg = event.data && event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'PICK_FILE') {
        const tmp = document.createElement('input');
        tmp.type = 'file'; tmp.accept = 'image/*';
        tmp.onchange = () => {
          const f = tmp.files?.[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = () => {
            parent.postMessage({ pluginMessage: { type: 'FILE_PICKED', data: reader.result } }, '*');
          };
          reader.readAsDataURL(f);
        };
        tmp.click();
      }

      if (msg.type === 'BOOT' && msg.state) {
        if ('avatarHash' in msg.state) setHash('avatar', msg.state.avatarHash);
        if ('wallpaperHash' in msg.state) setHash('wallpaper', msg.state.wallpaperHash);
        if ('messageImageHash' in msg.state) setHash('messageImage', msg.state.messageImageHash);
      }

      if (msg.type === 'STATE') {
        setHash(msg.target, msg.hash || '');
      }

      if (msg.type === 'READ_RESULT' && msg.target && msg.dataURL) {
        setPreview(msg.target, msg.dataURL);
      }
    };
  </script>
</
