<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body { font: 13px/1.4 -apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin: 12px; }
      h3 { margin: 12px 0 6px; }
      .card { border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px; margin-bottom: 12px; }
      .row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
      .hash { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; word-break: break-all; color: #666; }
      button { padding: 6px 10px; border-radius: 6px; border: 1px solid #d0d0d0; background: #fff; cursor: pointer; }
      button.primary { background: #0d99ff; color: white; border-color: #0d99ff; }
      input[type="file"] { display: none; }
      .preview { width: 72px; height: 72px; border-radius: 12px; background: #f3f3f3; object-fit: cover; border: 1px solid #e8e8e8; }
      .hint { color:#888; font-size:12px; }
    </style>
  </head>
  <body>
    <div class="card">
      <h3>Avatar</h3>
      <div class="row">
        <img id="p-avatar" class="preview" />
        <div>
          <div class="row">
            <button class="primary" id="pick-avatar">Choose image</button>
            <button id="upload-avatar">Upload</button>
            <button id="clear-avatar">Clear</button>
          </div>
          <div class="hash" id="hash-avatar"></div>
          <div class="hint">Saved to Shared Plugin Data: <b>tg_vault / avatarHash</b></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Wallpaper</h3>
      <div class="row">
        <img id="p-wallpaper" class="preview" />
        <div>
          <div class="row">
            <button class="primary" id="pick-wallpaper">Choose image</button>
            <button id="upload-wallpaper">Upload</button>
            <button id="clear-wallpaper">Clear</button>
          </div>
          <div class="hash" id="hash-wallpaper"></div>
          <div class="hint">Saved to Shared Plugin Data: <b>tg-vault / wallpaperHash</b></div>
        </div>
      </div>
    </div>

    <input id="file-avatar" type="file" accept="image/*" />
    <input id="file-wallpaper" type="file" accept="image/*" />

    <script>
      const $ = (id) => document.getElementById(id);

      const state = { avatarBytes: null, wallpaperBytes: null };

      function readFileAsBytes(file, previewEl) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const arrayBuffer = reader.result;
            const bytes = Array.from(new Uint8Array(arrayBuffer));
            const blobUrl = URL.createObjectURL(file);
            previewEl.src = blobUrl;
            resolve(bytes);
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      // Pickers
      $("pick-avatar").onclick = () => $("file-avatar").click();
      $("pick-wallpaper").onclick = () => $("file-wallpaper").click();

      $("file-avatar").onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        state.avatarBytes = await readFileAsBytes(file, $("p-avatar"));
      };

      $("file-wallpaper").onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        state.wallpaperBytes = await readFileAsBytes(file, $("p-wallpaper"));
      };

      // Upload
      $("upload-avatar").onclick = () => {
        if (!state.avatarBytes) return alert("Choose an image first");
        parent.postMessage({ pluginMessage: { type: "upload", role: "avatar", bytes: state.avatarBytes } }, "*");
      };
      $("upload-wallpaper").onclick = () => {
        if (!state.wallpaperBytes) return alert("Choose an image first");
        parent.postMessage({ pluginMessage: { type: "upload", role: "wallpaper", bytes: state.wallpaperBytes } }, "*");
      };

      // Clear
      $("clear-avatar").onclick = () => parent.postMessage({ pluginMessage: { type: "clear", role: "avatar" } }, "*");
      $("clear-wallpaper").onclick = () => parent.postMessage({ pluginMessage: { type: "clear", role: "wallpaper" } }, "*");

      // Init: read existing hashes
      parent.postMessage({ pluginMessage: { type: "read" } }, "*");

      // Backchannel
      onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "state") {
          $("hash-avatar").textContent = msg.avatarHash || "(empty)";
          $("hash-wallpaper").textContent = msg.wallpaperHash || "(empty)";
        }
        if (msg.type === "done") {
          if (msg.role === "avatar") $("hash-avatar").textContent = msg.hash || "(cleared)";
          if (msg.role === "wallpaper") $("hash-wallpaper").textContent = msg.hash || "(cleared)";
        }
        if (msg.type === "error") {
          alert("Plugin error: " + msg.message);
        }
      };
    </script>
  </body>
</html>
